<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matematik Ligi YÃ¶netim Sistemi â€” 6. SÄ±nÄ±flar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .qualified { background-color: #dcfce7 !important; }
    .flash { animation: flash 1.2s ease-out 1; }
    @keyframes flash { from { background:#fef9c3; } to { background:transparent; } }
    .btn-disabled { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-center mb-4">
        <div class="text-4xl mr-4">ğŸ’</div>
        <div class="text-center">
          <h1 class="text-3xl font-bold text-indigo-800 mb-2">ğŸ† Matematik Ligi</h1>
          <div class="text-center">
            <span class="text-gray-600 font-medium text-xl">6. SÄ±nÄ±flar Grup AÅŸamasÄ±</span>
          </div>
        </div>
        <div class="text-4xl ml-4">ğŸ“š</div>
      </div>
      <div class="flex justify-center items-center space-x-4 text-2xl">
        <span>âœï¸</span><span>ğŸ“</span><span>ğŸ§®</span><span>ğŸ“</span><span>ğŸ“</span><span>ğŸ”¢</span><span>â•</span><span>â–</span><span>âœ–ï¸</span><span>â—</span>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-lg shadow-lg mb-6">
      <div class="flex flex-wrap border-b">
        <button onclick="showTab('standings', this)" class="tab-btn px-4 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600">
          ğŸ“Š Puan Durumu
        </button>
        <button onclick="showTab('fixtures', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          ğŸ“… FikstÃ¼r
        </button>
        <button onclick="showTab('upcoming', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          â­ï¸ Gelecek MaÃ§
        </button>
        <button onclick="showTab('mini', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          ğŸ§© Toplu Puan Durumu
        </button>
        <button onclick="showTab('dataentry', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          ğŸ“¥ Veri GiriÅŸi
        </button>
      </div>
    </div>

    <!-- Standings Tab -->
    <div id="standings" class="tab-content active">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Puan Durumu</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup SeÃ§:</label>
          <select id="standingsGroupSelect" onchange="showStandings()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seÃ§in...</option>
          </select>
        </div>
        <div id="standingsContent"></div>
      </div>
    </div>

    <!-- Fixtures Tab -->
    <div id="fixtures" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">FikstÃ¼r ve SonuÃ§lar</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup SeÃ§:</label>
          <select id="fixtureGroupSelect" onchange="showFixtures()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seÃ§in...</option>
          </select>
        </div>

        <!-- Yedek Ä°ndir / YÃ¼kle â€” FikstÃ¼r iÃ§inde -->
        <div class="mb-4 flex gap-2">
          <button onclick="downloadBackup()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm">ğŸ’¾ YedeÄŸi Ä°ndir</button>
          <label class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm cursor-pointer">ğŸ“¤ Yedekten YÃ¼kle
            <input type="file" id="restoreInput" accept="application/json" class="hidden" onchange="restoreFromFile(event)" />
          </label>
        </div>

        <div id="fixtureContent"></div>
      </div>
    </div>

    <!-- Upcoming (All Groups by Week) -->
    <div id="upcoming" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Gelecek MaÃ§lar (Haftaya GÃ¶re)</h2>
        <div class="mb-4 flex items-end gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Hafta SeÃ§:</label>
            <select id="upcomingWeekSelect" class="border border-gray-300 rounded-lg px-3 py-2" onchange="showUpcoming()">
              <!-- doldurulacak -->
            </select>
          </div>
          <div class="text-sm text-gray-600">SeÃ§ilen haftada tÃ¼m gruplarÄ±n maÃ§larÄ± aÅŸaÄŸÄ±da listelenir.</div>
        </div>
        <div id="upcomingContent"></div>
      </div>
    </div>

    <!-- Toplu Mini Standings -->
    <div id="mini" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Toplu Puan Durumu</h2>
        <div id="miniContent" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>

    <!-- Data Entry Tab -->
    <div id="dataentry" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Veri GiriÅŸi (Toplu YapÄ±ÅŸtÄ±r)</h2>

        <div class="grid md:grid-cols-3 gap-4 mb-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Grup SeÃ§:</label>
            <select id="dataGroupSelect" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">Grup seÃ§in...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Hafta:</label>
            <select id="dataWeekSelect" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              <option value="7">7</option>
            </select>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnPreview" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg"
                    onclick="previewFromPaste()">EÅŸleÅŸtir & Ã–nizle</button>
            <button id="btnApplyTop" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg btn-disabled" disabled
                    onclick="applyFromTop()">SonuÃ§larÄ± Uygula</button>
          </div>
        </div>

        <div class="mb-2 text-sm text-gray-600">
          <p>BiÃ§im Ã¶rnekleri: <code>Ad<TAB>12</code> Â· <code>Ad,12</code> Â· <code>Ad; 12</code> Â· <code>Ad 12</code></p>
          <p>Listede adÄ± <u>yoksa</u> o Ã¶ÄŸrenci bu hafta <b>0</b> alÄ±r.</p>
        </div>

        <textarea id="pasteInput" rows="10" class="w-full border border-gray-300 rounded-lg p-3 font-mono text-sm"
          placeholder="Ã–ÄRENCÄ° ADI[TAB veya , ; boÅŸluk]PUAN
KERÄ°M MERT POLAT 11
PARS ERTAÅ 12
MEHMET YAMAN MUMCU 10"></textarea>

        <div id="previewArea" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script>
    // ----------- Depolama ve Model -----------
    const STORAGE_KEY = 'mathLeagueData6';
    let leagueData = { groups: {}, fixtures: {}, results: {}, matchIndex: {} };

    // ----------- Yedek / Geri YÃ¼kle -----------
    function createDownloadableBackup() {
      const dataStr = JSON.stringify(leagueData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      let a = document.getElementById('downloadBackup');
      if (!a) { a = document.createElement('a'); a.id = 'downloadBackup'; a.style.display = 'none'; document.body.appendChild(a); }
      a.href = URL.createObjectURL(dataBlob);
      a.download = `matematik_ligi_6sinif_yedek_${new Date().toISOString().slice(0,10)}.json`;
    }
    function downloadBackup(){ const a=document.getElementById('downloadBackup'); if(a) a.click(); }
    function restoreFromFile(ev){
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          if (obj && obj.groups && obj.fixtures && obj.results) {
            leagueData = { matchIndex:{}, ...obj };
            if (!leagueData.matchIndex) leagueData.matchIndex = {};
            Object.keys(leagueData.fixtures||{}).forEach(g => buildMatchIndex(g));
            migrateRenameAlp(); // eski yedek uyumluluÄŸu
            saveData();
            initializeGroups(); populateGroupSelects();
            showFixtures(); showStandings(); fillUpcomingWeekSelect(); showUpcoming(); renderMiniStandings();
            alert('âœ… Yedekten geri yÃ¼klendi');
          } else { alert('âŒ GeÃ§ersiz yedek dosyasÄ±'); }
        } catch { alert('âŒ Dosya okunamadÄ±'); }
        ev.target.value = '';
      };
      reader.readAsText(f);
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(leagueData));
        createDownloadableBackup();
      } catch(e){ console.error('Kaydetme hatasÄ±:', e); }
    }
    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try { leagueData = { matchIndex:{}, ...JSON.parse(saved) }; if (!leagueData.matchIndex) leagueData.matchIndex = {}; }
        catch(e){}
      }
    }

    // ----------- VarsayÄ±lan Gruplar (Sizin listeleriniz) -----------
    function initializeWithProvidedGroups() {
      leagueData.groups['A'] = ['KERÄ°M MERT POLAT','PARS ERTAÅ','MERT RIZGAR YEÅÄ°LMEN','BADE ÅAHÄ°N','MEHMET YAMAN MUMCU','KEREM SAYAR','ELÄ°F SARE GENÃ‡ALP','MERT ALÄ° ÃœNLÃœ'];
      leagueData.groups['B'] = ['YUSUF GÃ–KALP SAKARYA','LÄ°LA ERGÃœN','DURU MÄ°RA Ã–DÃœL','MÄ°RA TEMÃœR','KUZEY PEKÅEN','EFE Ã‡AÄLAR','DEMÄ°R ALÄ° KABAKTAÅ','EVÄ°N Ä°PEK Ã–ZGEN'];
      leagueData.groups['C'] = ['ABDULLAH EFE Ã–ZTÃœRK','EMÄ°R MÄ°RAS','KIVANÃ‡ KARABULUT','CEM AKDENÄ°Z','AYBÃœKE ÃœZE','EFE ATTEPE','ALÄ° DEMÄ°R Ã‡ABUK','ZUHAL UMAY Ã‡ETÄ°N'];
      leagueData.groups['D'] = ['ARVEN TÃœRK','DERÄ°N DEMÄ°RKAYA','TAN SOYÃ–Z','SELÄ°M SANCAK','BATU ÅAHÄ°N','EYMEN Ã–ZDEMÄ°R','MERT RIFAT Ã‡EBÄ°','ELÄ°F ADRÄ°ANA OKUR'];
      leagueData.groups['E'] = ['HALÄ°L Ä°BRAHÄ°M BAYSOY','POYRAZ ÃœNGÃœDER','TANEM DENÄ°Z MERTLER','MELÄ°S MÄ°RA OSMANBAÅ','DURU KÃœÃ‡ÃœKSÃœMBÃœL','RABÄ°A BAHAR Ã‡AN','Ä°NCÄ° JANSELÄ° KAVAL','BARIÅ TOKGÃ–Z'];
      leagueData.groups['F'] = ['DENÄ°Z Ã‡AKIR','DOÄUKAN ARSLAN','SELEN IÅIK','DOÄUKAN KILIÃ‡','AYSAN SEÄ°FZADEH','ALÄ° KAAN MERCAN','MEHMET Ã‡AÄAN KIZILOÄLU','ALYA SENA Ã‡Ä°Ã‡EK'];
      leagueData.groups['G'] = ['BATU DURUKAN','KENAN SARP Ã‡Ã–TE','EMÄ°RCAN RAHÄ°MOÄLU','ELÄ°S TEKE','SARP BALCIOÄLU','SEVÄ°NÃ‡ ECE BÄ°LGÄ°Ã‡','NASRÄ° Ã‡Ä°Ã‡EK','CEVDET AKÄ°F TOKLU'];
      leagueData.groups['H'] = ['MÄ°RA GÃ–ZENER','ASYA MÄ°NA Ã–Z','ARHAN AKARSU','AYÅE Ã–YKÃœ YILDIRIM','ANIL CANSU YILMAZ','NÄ°L ERSAN','KEREM TEKÄ°N','DERÄ°N SÄ°NEF DÄ°N'];
      leagueData.groups['I'] = ['BERAT AÄIRMAN','ATLAS BAHADIR','YAÄMUR ELÄ°F BÄ°NGÃ–L','MÄ°RA Ä°NECÄ°','CANSU YILMAZ','KEREM Ã–ZTÃœRK','CEMAL SALMANLI','ARES DOÄAN'];
      leagueData.groups['J'] = ['PELÄ°N USTA','DENÄ°Z GÃ–KSU','DERÄ°N BOZKURT','BELÄ°Z SU BAÅARSLAN','ASYA KARAMAN','Ä°PEK NÄ°SA KOÃ‡BAY','Ä°PEK PAPÄ°N','YUSUF EFE KARAGÃ–ZOÄLU'];
      leagueData.groups['K'] = ['AYAZ ALÄ° YILDIRIM','MÄ°RZA Ã–ZBEKLÄ°','ZEYNEP ARSLAN','SARP SALÄ°HOÄLU','SARE YILMAZ','ERDAL ATÄ°LLA ÅAKAR','KUZEY MERT YILMAZ','BARDIA EBRAHIMI ESHRATABADY'];
      leagueData.groups['L'] = ['YAÄIZ AVCI','ATLAS DENÄ°Z Ã‡ELÄ°K','DERÄ°N YALÃ‡INKAYA','BERKEN AREL AYAZ','Ã–MER KALEBAÅ','ECE NUR EGE','EGEMEN Ã‡ALIÅKAN','KERÄ°M KARKIN'];
      leagueData.groups['M'] = ['AYÅE SERRA KARTAL','YAÅAR YAMAN YOLCU','Ä°LAY MELEK MEYDAN','DENÄ°Z EROL BAÅARSLAN','Ã–YKÃœ Ã‡AP','ECE KÃœÃ‡ÃœKDALGIÃ‡','NAZLI USKUÃ‡','KAYRA RESUL GÃ–ZÃœBÃœYÃœK'];
      leagueData.groups['N'] = ['GÃœNEY ÅÄ°MÅEK','DORUK DOÄAN','ADA ERAKPINAR','DURU SAÄDIÃ‡','BÃ–LÃœM SONU CANAVARI','ABDULKADÄ°R ALP ALTINTAÅ','ELA YILMAZ','BADE SEZGÄ°N'];
    }

    // Eski yedeklerde "ALP ALTINTAÅ" ismi varsa -> "ABDULKADÄ°R ALP ALTINTAÅ" (N grubunda)
    function migrateRenameAlp(){
      const g = 'N';
      const OLD = 'ALP ALTINTAÅ';
      const NEW = 'ABDULKADÄ°R ALP ALTINTAÅ';
      const arr = leagueData.groups[g] || [];
      let changed = false;
      for (let i=0;i<arr.length;i++){
        if ((arr[i]||'').trim().toUpperCase() === OLD) { arr[i] = NEW; changed = true; }
      }
      leagueData.groups[g] = arr;
      // fikstÃ¼rlerde de adÄ± gÃ¼ncelle
      if (leagueData.fixtures[g]) {
        leagueData.fixtures[g].forEach(week => {
          (week.matches||[]).forEach(m=>{
            if (m.home && m.home.toUpperCase() === OLD) m.home = NEW;
            if (m.away && m.away.toUpperCase() === OLD) m.away = NEW;
          });
        });
      }
      if (changed) saveData();
    }

    // ----------- YardÄ±mcÄ±lar -----------
    function initializeGroups() {
      'ABCDEFGHIJKLMN'.split('').forEach(letter => {
        const cap = 8;
        if (!leagueData.groups[letter]) leagueData.groups[letter] = Array(cap).fill('');
      });
    }

    function populateGroupSelects() {
      const fixtureSelect = document.getElementById('fixtureGroupSelect');
      const standingsSelect = document.getElementById('standingsGroupSelect');
      const dataGroupSelect = document.getElementById('dataGroupSelect');
      if (fixtureSelect) fixtureSelect.innerHTML = '<option value="">Grup seÃ§in...</option>';
      if (standingsSelect) standingsSelect.innerHTML = '<option value="">Grup seÃ§in...</option>';
      if (dataGroupSelect) dataGroupSelect.innerHTML = '<option value="">Grup seÃ§in...</option>';
      'ABCDEFGHIJKLMN'.split('').forEach(g => {
        const hasMember = (leagueData.groups[g]||[]).some(n => n && n.trim() !== '');
        if (hasMember) {
          const text = 'Grup ' + g;
          if (fixtureSelect){ const o1=document.createElement('option'); o1.value=g; o1.textContent=text; fixtureSelect.appendChild(o1); }
          if (standingsSelect){ const o2=document.createElement('option'); o2.value=g; o2.textContent=text; standingsSelect.appendChild(o2); }
          if (dataGroupSelect){ const o3=document.createElement('option'); o3.value=g; o3.textContent=text; dataGroupSelect.appendChild(o3); }
        }
      });
    }

    // ----------- FikstÃ¼r Ãœretimi (7'lerdeki ile aynÄ± mantÄ±k) -----------
    function generateFixtures(group) {
      const members = (leagueData.groups[group] || []).filter(m => m && m.trim() !== '');
      const n = members.length; if (n < 2) return [];
      const fixtures = []; const totalWeeks = n % 2 === 0 ? n - 1 : n;
      for (let w = 1; w <= totalWeeks; w++) fixtures.push({ week: w, matches: [] });
      let matchId = 0; const allMatches = [];
      for (let i = 0; i < n; i++) for (let j = i + 1; j < n; j++) allMatches.push({ id: `${group}_${matchId++}`, home: members[i], away: members[j] });
      let wi = 0; for (const m of allMatches) {
        let placed = false, tries = 0;
        while (!placed && tries < totalWeeks) {
          const week = fixtures[wi];
          const used = new Set(); week.matches.forEach(x => { used.add(x.home); used.add(x.away); });
          if (!used.has(m.home) && !used.has(m.away)) { week.matches.push({ ...m }); placed = true; }
          wi = (wi + 1) % totalWeeks; tries++;
        }
      }
      return fixtures;
    }
    function ensureFixturesForGroup(g){
      if (!leagueData.fixtures[g] || !leagueData.fixtures[g].length){
        leagueData.fixtures[g] = generateFixtures(g);
      }
    }
    function buildMatchIndex(group){
      const weeks = leagueData.fixtures[group]||[];
      weeks.forEach(w => (w.matches||[]).forEach(m => { leagueData.matchIndex[m.id] = { group, home:m.home, away:m.away, week:w.week }; }));
    }

    // ----------- FikstÃ¼r + Skor KaydÄ± -----------
    function showFixtures() {
      const group = document.getElementById('fixtureGroupSelect').value;
      const content = document.getElementById('fixtureContent');
      if (!group) { content.innerHTML = '<p class="text-gray-500">LÃ¼tfen bir grup seÃ§in.</p>'; return; }
      ensureFixturesForGroup(group);
      const fixtures = leagueData.fixtures[group];
      content.innerHTML = `
        <div class="space-y-6">
          ${fixtures.map(week => `
            <div id="week_${week.week}" class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-bold text-lg mb-3 text-indigo-700">${week.week}. Hafta</h3>
              <div class="space-y-2">
                ${week.matches.map(match => `
                  <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded">
                    <span class="flex-1 text-right font-medium">${match.home}</span>
                    <input type="number"
                           value="${leagueData.results[match.id]?.homeScore ?? ''}"
                           oninput="updateScore('${match.id}', 'homeScore', this.value)"
                           class="w-12 text-center border border-gray-300 rounded px-2 py-1">
                    <span class="text-gray-500">-</span>
                    <input type="number"
                           value="${leagueData.results[match.id]?.awayScore ?? ''}"
                           oninput="updateScore('${match.id}', 'awayScore', this.value)"
                           class="w-12 text-center border border-gray-300 rounded px-2 py-1">
                    <span class="flex-1 font-medium">${match.away}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>`;
    }

    function updateScore(matchId, key, val) {
      if (!leagueData.results[matchId]) leagueData.results[matchId] = {};
      if (val === '') { leagueData.results[matchId][key] = ''; }
      else {
        const n = parseInt(val);
        leagueData.results[matchId][key] = isNaN(n) ? '' : n;
      }
      saveData();
      const group = matchId.split('_')[0];
      if (document.getElementById('standingsGroupSelect').value === group) showStandings();
      renderMiniStandings(); // mini tablolarÄ± da gÃ¼ncelle
    }

    // ----------- Puan Durumu -----------
    function calculateStandings(group) {
      const members = (leagueData.groups[group] || []).filter(m => m.trim() !== '');
      const standings = members.map(member => ({ name: member, played: 0, won: 0, drawn: 0, lost: 0, correct: 0, wrong: 0, goalDifference: 0, points: 0 }));
      Object.keys(leagueData.results).forEach(matchId => {
        if (!matchId.startsWith(group + '_')) return;
        const result = leagueData.results[matchId];
        if (result.homeScore === '' || result.awayScore === '' || result.homeScore == null || result.awayScore == null) return;
        const homeScore = parseInt(result.homeScore) || 0;
        const awayScore = parseInt(result.awayScore) || 0;
        const fixtures = leagueData.fixtures[group] || [];
        let homeTeam, awayTeam;
        fixtures.forEach(week => week.matches.forEach(match => { if (match.id === matchId) { homeTeam = match.home; awayTeam = match.away; } }));
        if (!homeTeam || !awayTeam) return;
        const homeIndex = standings.findIndex(s => s.name === homeTeam);
        const awayIndex = standings.findIndex(s => s.name === awayTeam);
        if (homeIndex === -1 || awayIndex === -1) return;
        standings[homeIndex].played++; standings[awayIndex].played++;
        standings[homeIndex].correct += homeScore; standings[homeIndex].wrong += awayScore;
        standings[awayIndex].correct += awayScore; standings[awayIndex].wrong += homeScore;
        if (homeScore > awayScore) { standings[homeIndex].won++; standings[homeIndex].points += 3; standings[awayIndex].lost++; }
        else if (homeScore < awayScore) { standings[awayIndex].won++; standings[awayIndex].points += 3; standings[homeIndex].lost++; }
        else { standings[homeIndex].drawn++; standings[awayIndex].drawn++; standings[homeIndex].points++; standings[awayIndex].points++; }
        standings[homeIndex].goalDifference = standings[homeIndex].correct - standings[homeIndex].wrong;
        standings[awayIndex].goalDifference = standings[awayIndex].correct - standings[awayIndex].wrong;
      });
      standings.sort((a, b) => (b.points - a.points) || (b.goalDifference - a.goalDifference) || (b.correct - a.correct));
      return standings;
    }

    function showStandings() {
      const group = document.getElementById('standingsGroupSelect').value;
      const content = document.getElementById('standingsContent');
      if (!group) { content.innerHTML = '<p class="text-gray-500">LÃ¼tfen bir grup seÃ§in.</p>'; return; }
      const standings = calculateStandings(group);
      const qualifyCount = 4;
      content.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-indigo-600 text-white">
                <th class="border border-gray-300 px-3 py-2 text-center">SÄ±ra</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Ã–ÄŸrenci</th>
                <th class="border border-gray-300 px-3 py-2 text-center">O</th>
                <th class="border border-gray-300 px-3 py-2 text-center">G</th>
                <th class="border border-gray-300 px-3 py-2 text-center">B</th>
                <th class="border border-gray-300 px-3 py-2 text-center">M</th>
                <th class="border border-gray-300 px-3 py-2 text-center">P</th>
              </tr>
            </thead>
            <tbody>
              ${standings.map((team, i) => `
                <tr class="${i < qualifyCount ? 'qualified' : ''}">
                  <td class="border border-gray-300 px-3 py-2 text-center font-bold">${i + 1}</td>
                  <td class="border border-gray-300 px-3 py-2 font-medium">${team.name}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.played}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.won}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.drawn}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center">${team.lost}</td>
                  <td class="border border-gray-300 px-3 py-2 text-center font-bold">${team.points}</td>
                </tr>`).join('')}
            </tbody>
          </table>
          <div class="mt-4 text-sm text-gray-600">
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-green-200 border border-green-300"></div>
              <span>Bir sonraki tura Ã§Ä±kan Ã¶ÄŸrenciler (Ä°lk ${qualifyCount})</span>
            </div>
          </div>
        </div>`;
      renderMiniStandings(); // mini tablolarÄ± senkron tut
    }

    // ----------- TR Ä°sim Normalizasyonu + YapÄ±ÅŸtÄ±rma -----------
    function normName(s){
      if (!s) return '';
      return s.replace(/\u00A0/g,' ').normalize('NFKC').trim().replace(/\s+/g,' ').toLocaleUpperCase('tr-TR');
    }
    function parsePasted(text){
      const map = {};
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      for (const raw of lines){
        const line = raw.replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
        let m = line.match(/^(.*?)[\t,;:|-]\s*([0-9]+)$/);
        if (!m) m = line.match(/^(.*)\s+([0-9]+)$/);
        if (m){
          const name = normName(m[1]);
          const score = parseInt(m[2],10);
          if (!isNaN(score) && name) map[name] = score;
        }
      }
      return map;
    }

    function previewFromPaste(){
      const g = document.getElementById('dataGroupSelect').value;
      const week = parseInt(document.getElementById('dataWeekSelect').value,10);
      const txt = document.getElementById('pasteInput').value;
      const area = document.getElementById('previewArea');

      if (!g){ area.innerHTML = '<p class="text-red-600">LÃ¼tfen grup seÃ§in.</p>'; return; }
      ensureFixturesForGroup(g);

      const fixtures = leagueData.fixtures[g] || [];
      const thisWeek = fixtures.find(w => w.week === week);
      if (!thisWeek){ area.innerHTML = '<p class="text-red-600">Bu grup iÃ§in bu hafta yok.</p>'; return; }

      const map = parsePasted(txt);
      const groupMembers = (leagueData.groups[g]||[]).map(normName);
      const unknown = Object.keys(map).filter(n => !groupMembers.includes(n));

      let html = '';
      html += `<div class="mb-3 text-sm text-gray-700">EÅŸleÅŸen skorlar <b>Hafta ${week}</b> iÃ§in hazÄ±rlanÄ±yor. Listede olmayan Ã¶ÄŸrenciler otomatik <b>0</b> alacak.</div>`;
      if (unknown.length){
        html += `<div class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm">
          Bu isimler grupta bulunamadÄ± ve yok sayÄ±lacak: <b>${unknown.join(', ')}</b>
        </div>`;
      }
      html += `<div class="overflow-x-auto"><table class="w-full border-collapse">
        <thead><tr class="bg-gray-100">
          <th class="border px-2 py-1 text-left">Ev Sahibi</th>
          <th class="border px-2 py-1 w-20">Skor</th>
          <th class="border px-2 py-1 w-6"></th>
          <th class="border px-2 py-1 text-left">Deplasman</th>
          <th class="border px-2 py-1 w-20">Skor</th>
        </tr></thead><tbody>`;

      const rows = thisWeek.matches.map(m=>{
        const hs = map[normName(m.home)] ?? 0;
        const as = map[normName(m.away)] ?? 0;
        return `<tr>
          <td class="border px-2 py-1">${m.home}</td>
          <td class="border px-2 py-1 text-center">${hs}</td>
          <td class="border px-2 py-1 text-center">-</td>
          <td class="border px-2 py-1">${m.away}</td>
          <td class="border px-2 py-1 text-center">${as}</td>
        </tr>`;
      }).join('');

      html += rows + `</tbody></table></div>`;

      window.__previewData6 = { group:g, week, map };
      const btn = document.getElementById('btnApplyTop');
      if (btn) { btn.disabled = false; btn.classList.remove('btn-disabled'); }
      area.innerHTML = html + `<div class="mt-3 text-xs text-gray-500">Ã–nizleme hazÄ±r. YukarÄ±daki <b>SonuÃ§larÄ± Uygula</b> dÃ¼ÄŸmesi aktif.</div>`;
    }

    function applyFromTop(){
      const pd = window.__previewData6;
      if (!pd) { alert('Ã–nce EÅŸleÅŸtir & Ã–nizle yapÄ±n.'); return; }
      applyPreview(pd.group, pd.week);
    }

    function applyPreview(g, week){
      const pd = window.__previewData6;
      if (!pd || pd.group !== g || pd.week !== week) return;
      ensureFixturesForGroup(g);
      const thisWeek = (leagueData.fixtures[g]||[]).find(w => w.week === week);
      if (!thisWeek) return;

      for (const m of thisWeek.matches){
        const hs = pd.map[normName(m.home)] ?? 0;
        const as = pd.map[normName(m.away)] ?? 0;
        if (!leagueData.results[m.id]) leagueData.results[m.id] = {};
        leagueData.results[m.id].homeScore = hs;
        leagueData.results[m.id].awayScore = as;
      }
      saveData();

      // FikstÃ¼r gÃ¶rÃ¼nÃ¼mÃ¼ senkronize et
      const fixtureSelect = document.getElementById('fixtureGroupSelect');
      if (fixtureSelect) fixtureSelect.value = g;
      showFixtures();
      const target = document.getElementById('week_' + week);
      if (target) { target.classList.add('flash'); target.scrollIntoView({behavior:'smooth', block:'start'}); setTimeout(()=>target.classList.remove('flash'),1200); }

      if (document.getElementById('standingsGroupSelect').value === g) showStandings();
      renderMiniStandings();

      const area = document.getElementById('previewArea');
      area.innerHTML = '<div class="p-3 rounded bg-emerald-50 border border-emerald-200 text-emerald-800">âœ… SonuÃ§lar kaydedildi. FikstÃ¼r ve Puan Durumu gÃ¼ncellendi.</div>';
      const btn = document.getElementById('btnApplyTop');
      if (btn) { btn.disabled = true; btn.classList.add('btn-disabled'); }
    }

    // ----------- Gelecek MaÃ§lar (tÃ¼m gruplar) -----------
    function fillUpcomingWeekSelect(){
      let maxWeek = 0;
      'ABCDEFGHIJKLMN'.split('').forEach(g => {
        ensureFixturesForGroup(g);
        const weeks = leagueData.fixtures[g]?.length || 0;
        if (weeks > maxWeek) maxWeek = weeks;
      });
      const sel = document.getElementById('upcomingWeekSelect');
      if (!sel) return;
      sel.innerHTML = '';
      for (let w=1; w<=maxWeek; w++){
        const o = document.createElement('option'); o.value = String(w); o.textContent = w + '. Hafta'; sel.appendChild(o);
      }
      if (!sel.value) sel.value = '1';
    }

    function showUpcoming(){
      const sel = document.getElementById('upcomingWeekSelect');
      const week = parseInt(sel?.value || '1', 10);
      const out = document.getElementById('upcomingContent');
      if (!out) return;

      let html = '';
      'ABCDEFGHIJKLMN'.split('').forEach(g => {
        const fixtures = leagueData.fixtures[g] || [];
        const w = fixtures.find(x => x.week === week);
        if (w && w.matches && w.matches.length){
          html += `<div class="mb-6 border border-gray-200 rounded-lg">
            <div class="px-4 py-2 bg-indigo-50 border-b border-gray-200 font-semibold text-indigo-800">Grup ${g} â€” ${week}. Hafta</div>
            <div class="p-4 space-y-2">`;
          html += w.matches.map(m => {
            const res = leagueData.results[m.id];
            const hasScore = res && res.homeScore !== '' && res.awayScore !== '' && res.homeScore != null && res.awayScore != null;
            return `<div class="flex items-center bg-white rounded px-3 py-2 shadow-sm">
              <span class="flex-1 text-right font-medium">${m.home}</span>
              <span class="mx-2 text-gray-500">vs</span>
              <span class="flex-1 font-medium">${m.away}</span>
              ${hasScore ? `<span class="ml-3 text-sm text-gray-600">(${res.homeScore} - ${res.awayScore})</span>` : ''}
            </div>`;
          }).join('');
          html += `</div></div>`;
        }
      });

      if (!html){
        html = `<div class="text-gray-500">Bu hafta iÃ§in listelenecek maÃ§ bulunamadÄ±.</div>`;
      }
      out.innerHTML = html;
    }

    // ----------- Toplu Puan Durumu (mini tablolar) -----------
    function renderMiniStandings(){
      const wrap = document.getElementById('miniContent');
      if (!wrap) return;
      let html = '';
      'ABCDEFGHIJKLMN'.split('').forEach(g => {
        const members = (leagueData.groups[g]||[]).filter(x => x && x.trim() !== '');
        if (!members.length) return;
        ensureFixturesForGroup(g);
        const standings = calculateStandings(g);

        html += `<div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
          <div class="px-3 py-2 bg-indigo-50 border-b border-gray-200 font-semibold text-indigo-800">Grup ${g}</div>
          <div class="p-3 overflow-x-auto">
            <table class="w-full text-xs border-collapse">
              <thead>
                <tr class="text-gray-700">
                  <th class="border border-gray-200 px-2 py-1 text-center">S</th>
                  <th class="border border-gray-200 px-2 py-1 text-left">Ã–ÄŸrenci</th>
                  <th class="border border-gray-200 px-2 py-1 text-center">O</th>
                  <th class="border border-gray-200 px-2 py-1 text-center">G</th>
                  <th class="border border-gray-200 px-2 py-1 text-center">B</th>
                  <th class="border border-gray-200 px-2 py-1 text-center">M</th>
                  <th class="border border-gray-200 px-2 py-1 text-center">P</th>
                </tr>
              </thead>
              <tbody>
                ${standings.map((t, i) => `
                  <tr class="${i < 4 ? 'qualified' : ''}">
                    <td class="border border-gray-200 px-2 py-1 text-center font-medium">${i+1}</td>
                    <td class="border border-gray-200 px-2 py-1">${t.name}</td>
                    <td class="border border-gray-200 px-2 py-1 text-center">${t.played}</td>
                    <td class="border border-gray-200 px-2 py-1 text-center">${t.won}</td>
                    <td class="border border-gray-200 px-2 py-1 text-center">${t.drawn}</td>
                    <td class="border border-gray-200 px-2 py-1 text-center">${t.lost}</td>
                    <td class="border border-gray-200 px-2 py-1 text-center font-bold">${t.points}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
      });
      wrap.innerHTML = html || '<div class="text-gray-500 text-sm">HenÃ¼z listelenecek grup bulunamadÄ±.</div>';
    }

    // ----------- Sekmeler -----------
    function showTab(tabName, btn) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('text-indigo-600','border-b-2','border-indigo-600'); b.classList.add('text-gray-500'); });
      if (btn) { btn.classList.remove('text-gray-500'); btn.classList.add('text-indigo-600','border-b-2','border-indigo-600'); }
      if (tabName === 'standings') showStandings();
      if (tabName === 'fixtures') showFixtures();
      if (tabName === 'upcoming') { fillUpcomingWeekSelect(); showUpcoming(); }
      if (tabName === 'mini') renderMiniStandings();
    }

    // ----------- Init -----------
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      // HiÃ§ veri yoksa sizin gruplarÄ± yÃ¼kle
      const hasAnyMember = Object.values(leagueData.groups || {}).some(arr => Array.isArray(arr) && arr.some(n => n && n.trim() !== ''));
      if (!hasAnyMember) {
        initializeWithProvidedGroups();
      }

      migrateRenameAlp();

      initializeGroups();
      'ABCDEFGHIJKLMN'.split('').forEach(g => { ensureFixturesForGroup(g); buildMatchIndex(g); });

      saveData();
      populateGroupSelects();
      createDownloadableBackup();

      // Puan Durumu iÃ§in ilk uygun grubu otomatik seÃ§
      const selS = document.getElementById('standingsGroupSelect');
      if (selS && selS.options.length > 1) { selS.selectedIndex = 1; showStandings(); }

      // Gelecek MaÃ§ iÃ§in hafta selectini doldur
      fillUpcomingWeekSelect();
      showUpcoming();

      // Mini tablolarÄ± ilk yÃ¼klemede hazÄ±rla
      renderMiniStandings();
    });
  </script>
  <a id="downloadBackup" style="display:none"></a>
</body>
</html>
