<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matematik Ligi Yönetim Sistemi — 6. Sınıflar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .qualified { background-color: #dcfce7 !important; }
    .flash { animation: flash 1.2s ease-out 1; }
    @keyframes flash { from { background:#fef9c3; } to { background:transparent; } }
    .btn-disabled { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-center mb-4">
        <div class="text-4xl mr-4">🎒</div>
        <div class="text-center">
          <h1 class="text-3xl font-bold text-indigo-800 mb-2">🏆 Matematik Ligi</h1>
          <div class="text-center">
            <span class="text-gray-600 font-medium text-xl">6. Sınıflar Grup Aşaması</span>
          </div>
        </div>
        <div class="text-4xl ml-4">📚</div>
      </div>
      <div class="flex justify-center items-center space-x-4 text-2xl">
        <span>✏️</span><span>📝</span><span>🧮</span><span>📐</span><span>📏</span><span>🔢</span><span>➕</span><span>➖</span><span>✖️</span><span>➗</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-lg mb-6">
      <div class="flex flex-wrap border-b">
        <button onclick="showTab('standings', this)" class="tab-btn px-4 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600">
          📊 Puan Durumu
        </button>
        <button onclick="showTab('fixtures', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          📅 Fikstür
        </button>
        <button onclick="showTab('upcoming', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          🗓️ Gelecek Maçlar
        </button>
        <button onclick="showTab('allstandings', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          🧩 Toplu Puan Durumu
        </button>
        <button onclick="showTab('dataentry', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          📥 Veri Girişi
        </button>
      </div>
    </div>

    <!-- Standings -->
    <div id="standings" class="tab-content active">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Puan Durumu</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="standingsGroupSelect" onchange="showStandings()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>
        <div id="standingsContent"></div>
      </div>
    </div>

    <!-- Fixtures -->
    <div id="fixtures" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Fikstür ve Sonuçlar</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="fixtureGroupSelect" onchange="showFixtures()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>

        <!-- Yedek İndir / Yükle -->
        <div class="mb-4 flex gap-2">
          <button onclick="downloadBackup()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm">💾 Yedeği İndir</button>
          <label class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm cursor-pointer">📤 Yedekten Yükle
            <input type="file" id="restoreInput" accept="application/json" class="hidden" onchange="restoreFromFile(event)" />
          </label>
        </div>

        <div id="fixtureContent"></div>
      </div>
    </div>

    <!-- Upcoming -->
    <div id="upcoming" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-end gap-4 mb-4">
          <div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Gelecek Maçlar</h2>
            <p class="text-sm text-gray-600">Seçtiğiniz haftadaki tüm grupların maçları listelenir.</p>
          </div>
          <div class="ml-auto">
            <label class="block text-sm font-medium text-gray-700 mb-2">Hafta Seç:</label>
            <select id="upcomingWeekSelect" class="border border-gray-300 rounded-lg px-3 py-2" onchange="showUpcoming()">
              <!-- JS doldurur -->
            </select>
          </div>
        </div>
        <div id="upcomingContent"></div>
      </div>
    </div>

    <!-- All Standings (mini) -->
    <div id="allstandings" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Toplu Puan Durumu</h2>
        <p class="text-sm text-gray-600 mb-4">Tüm grupların özet tabloları. (Ekran genişse ikişer sütun olarak görünür.)</p>
        <div id="allStandingsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>

    <!-- Data Entry -->
    <div id="dataentry" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Veri Girişi (Toplu Yapıştır)</h2>

        <div class="grid md:grid-cols-3 gap-4 mb-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
            <select id="dataGroupSelect" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">Grup seçin...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Hafta:</label>
            <select id="dataWeekSelect" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              <option value="7">7</option>
            </select>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnPreview" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg"
                    onclick="previewFromPaste()">Eşleştir & Önizle</button>
            <button id="btnApplyTop" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg btn-disabled" disabled
                    onclick="applyFromTop()">Sonuçları Uygula</button>
          </div>
        </div>

        <div class="mb-2 text-sm text-gray-600">
          <p>Biçim örnekleri: <code>Ad<TAB>12</code> · <code>Ad,12</code> · <code>Ad; 12</code> · <code>Ad 12</code></p>
          <p>Listede adı <u>yoksa</u> o öğrenci bu hafta <b>0</b> alır.</p>
        </div>

        <textarea id="pasteInput" rows="10" class="w-full border border-gray-300 rounded-lg p-3 font-mono text-sm"
          placeholder="ÖĞRENCİ ADI[TAB veya , ; boşluk]PUAN
MELİS MİRA OSMANBAŞ 11
YAĞIZ AVCI 12
DURU KÜÇÜKSÜMBÜL 10"></textarea>

        <div id="previewArea" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'mathLeagueData6';
    let leagueData = { groups: {}, fixtures: {}, results: {}, matchIndex: {} };

    /* ---------- Yedekleme ---------- */
    function createDownloadableBackup() {
      const dataStr = JSON.stringify(leagueData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      let a = document.getElementById('downloadBackup');
      if (!a) { a = document.createElement('a'); a.id = 'downloadBackup'; a.style.display='none'; document.body.appendChild(a); }
      a.href = URL.createObjectURL(dataBlob);
      a.download = `matematik_ligi_6sinif_yedek_${new Date().toISOString().slice(0,10)}.json`;
    }
    function downloadBackup(){ document.getElementById('downloadBackup')?.click(); }
    function restoreFromFile(ev){
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if (obj && obj.groups && obj.fixtures && obj.results){
            leagueData = { matchIndex:{}, ...obj }; if (!leagueData.matchIndex) leagueData.matchIndex = {};
            Object.keys(leagueData.fixtures||{}).forEach(g => buildMatchIndex(g));
            saveData();
            initializeGroups(); populateGroupSelects();
            showFixtures(); showStandings();
            fillUpcomingWeekSelect(); showUpcoming();
            renderAllStandings();
            alert('✅ Yedekten geri yüklendi');
          } else alert('❌ Geçersiz yedek dosyası');
        }catch{ alert('❌ Dosya okunamadı'); }
        ev.target.value='';
      };
      reader.readAsText(f);
    }

    function saveData(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(leagueData)); createDownloadableBackup(); }catch(e){ console.error(e); } }
    function loadData(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved){ try{ leagueData = { matchIndex:{}, ...JSON.parse(saved) }; if (!leagueData.matchIndex) leagueData.matchIndex = {}; }catch{} }
    }

    /* ---------- Örnek Gruplar (gerekirse) ---------- */
    function initializeWithSampleData() {
      leagueData.groups['E'] = ['MELİS MİRA OSMANBAŞ','DURU KÜÇÜKSÜMBÜL','HALİL İBRAHİM BAYSOY','TANEM DENİZ MERTLER','POYRAZ ÜNGÜDER','RABİA BAHAR ÇAN','İNCİ JANSELİ KAVAL','BARIŞ TOKGÖZ'];
      leagueData.groups['L'] = ['BERKEN AREL AYAZ','ÖMER KALEBAŞ','ECE NUR EGE','KERİM KARKIN','EGEMEN ÇALIŞKAN','YAĞIZ AVCI','DERİN YALÇINKAYA','ATLAS DENİZ ÇELİK'];
    }

    function initializeGroups(){
      'ABCDEFGHIJKLMN'.split('').forEach(letter=>{
        const cap=8;
        if (!leagueData.groups[letter]) leagueData.groups[letter] = Array(cap).fill('');
      });
    }

    /* ---------- Fikstür ---------- */
    function generateFixtures(group){
      const members=(leagueData.groups[group]||[]).filter(m=>m && m.trim()!=='');
      const n=members.length; if (n<2) return [];
      const fixtures=[]; const totalWeeks=(n%2===0)?n-1:n;
      for(let w=1; w<=totalWeeks; w++) fixtures.push({ week:w, matches:[] });
      let matchId=0; const allMatches=[];
      for(let i=0;i<n;i++) for(let j=i+1;j<n;j++) allMatches.push({ id:`${group}_${matchId++}`, home:members[i], away:members[j] });
      let wi=0; for(const m of allMatches){
        let placed=false, tries=0;
        while(!placed && tries<totalWeeks){
          const week=fixtures[wi];
          const used=new Set(); week.matches.forEach(x=>{used.add(x.home); used.add(x.away);});
          if(!used.has(m.home) && !used.has(m.away)){ week.matches.push({...m}); placed=true; }
          wi=(wi+1)%totalWeeks; tries++;
        }
      }
      return fixtures;
    }
    function ensureFixturesForGroup(g){
      if (!leagueData.fixtures[g] || !leagueData.fixtures[g].length){ leagueData.fixtures[g]=generateFixtures(g); }
      buildMatchIndex(g, leagueData.fixtures[g]);
    }
    function buildMatchIndex(g, fixturesOpt){
      const fixtures=fixturesOpt || leagueData.fixtures[g] || [];
      leagueData.matchIndex = leagueData.matchIndex || {};
      for(const w of fixtures){ for(const m of w.matches){ leagueData.matchIndex[m.id]={group:g, week:w.week, home:m.home, away:m.away}; } }
      saveData();
    }

    /* ---------- Selectleri doldur ---------- */
    function populateGroupSelects(){
      const fixtureSelect=document.getElementById('fixtureGroupSelect');
      const standingsSelect=document.getElementById('standingsGroupSelect');
      const dataGroupSelect=document.getElementById('dataGroupSelect');
      if (fixtureSelect) fixtureSelect.innerHTML='<option value="">Grup seçin...</option>';
      if (standingsSelect) standingsSelect.innerHTML='<option value="">Grup seçin...</option>';
      if (dataGroupSelect) dataGroupSelect.innerHTML='<option value="">Grup seçin...</option>';
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{
        const hasMember=(leagueData.groups[g]||[]).some(n=>n && n.trim()!=='');
        if (hasMember){
          const text='Grup '+g;
          if (fixtureSelect){ const o1=document.createElement('option'); o1.value=g; o1.textContent=text; fixtureSelect.appendChild(o1); }
          if (standingsSelect){ const o2=document.createElement('option'); o2.value=g; o2.textContent=text; standingsSelect.appendChild(o2); }
          if (dataGroupSelect){ const o3=document.createElement('option'); o3.value=g; o3.textContent=text; dataGroupSelect.appendChild(o3); }
        }
      });
    }

    /* ---------- Fikstür + Skor Kaydı ---------- */
    function showFixtures(){
      const group=document.getElementById('fixtureGroupSelect').value;
      const content=document.getElementById('fixtureContent');
      if (!group){ content.innerHTML='<p class="text-gray-500">Lütfen bir grup seçin.</p>'; return; }
      ensureFixturesForGroup(group);
      const fixtures=leagueData.fixtures[group];
      content.innerHTML = `
        <div class="space-y-6">
          ${fixtures.map(week=>`
            <div id="week_${week.week}" class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-bold text-lg mb-3 text-indigo-700">${week.week}. Hafta</h3>
              <div class="space-y-2">
                ${week.matches.map(match=>`
                  <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded">
                    <span class="flex-1 text-right font-medium">${match.home}</span>
                    <input type="number" value="${leagueData.results[match.id]?.homeScore ?? ''}"
                           oninput="updateScore('${match.id}','homeScore',this.value)"
                           class="w-12 text-center border border-gray-300 rounded px-2 py-1">
                    <span class="text-gray-500">-</span>
                    <input type="number" value="${leagueData.results[match.id]?.awayScore ?? ''}"
                           oninput="updateScore('${match.id}','awayScore',this.value)"
                           class="w-12 text-center border border-gray-300 rounded px-2 py-1">
                    <span class="flex-1 font-medium">${match.away}</span>
                  </div>`).join('')}
              </div>
            </div>`).join('')}
        </div>`;
    }
    function updateScore(matchId, key, val){
      if (!leagueData.results[matchId]) leagueData.results[matchId]={};
      if (val===''){ leagueData.results[matchId][key]=''; }
      else {
        const n=parseInt(val,10);
        leagueData.results[matchId][key]=isNaN(n)?'':n;
      }
      saveData();
      const g=(leagueData.matchIndex[matchId]?.group) || matchId.split('_')[0];
      if (document.getElementById('standingsGroupSelect').value===g) showStandings();
      if (document.getElementById('allstandings').classList.contains('active')) renderAllStandings();
    }

    /* ---------- Puan Durumu ---------- */
    function calculateStandings(group){
      const members=(leagueData.groups[group]||[]).filter(m=>m.trim()!=='');
      const standings=members.map(member=>({name:member, played:0, won:0, drawn:0, lost:0, correct:0, wrong:0, goalDifference:0, points:0}));
      const idx=Object.fromEntries(standings.map((s,i)=>[s.name,i]));
      Object.keys(leagueData.results||{}).forEach(matchId=>{
        const meta=leagueData.matchIndex[matchId];
        if (!meta || meta.group!==group) return;
        const r=leagueData.results[matchId];
        if (r.homeScore==='' || r.awayScore==='' || r.homeScore==null || r.awayScore==null) return;
        const hi=idx[meta.home], ai=idx[meta.away]; if (hi==null || ai==null) return;
        const hs=parseInt(r.homeScore)||0, as=parseInt(r.awayScore)||0;
        const H=standings[hi], A=standings[ai];
        H.played++; A.played++;
        H.correct+=hs; H.wrong+=as;
        A.correct+=as; A.wrong+=hs;
        if (hs>as){ H.won++; H.points+=3; A.lost++; }
        else if (hs<as){ A.won++; A.points+=3; H.lost++; }
        else { H.drawn++; A.drawn++; H.points++; A.points++; }
        H.goalDifference=H.correct-H.wrong;
        A.goalDifference=A.correct-A.wrong;
      });
      standings.sort((a,b)=>(b.points-a.points)||(b.goalDifference-a.goalDifference)||(b.correct-a.correct));
      return standings;
    }
    function showStandings(){
      const group=document.getElementById('standingsGroupSelect').value;
      const content=document.getElementById('standingsContent');
      if (!group){ content.innerHTML='<p class="text-gray-500">Lütfen bir grup seçin.</p>'; return; }
      ensureFixturesForGroup(group);
      const st=calculateStandings(group);
      const qualifyCount=4;
      let html=`
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-indigo-600 text-white">
                <th class="border px-3 py-2 text-center">Sıra</th>
                <th class="border px-3 py-2 text-left">Öğrenci</th>
                <th class="border px-3 py-2 text-center">O</th>
                <th class="border px-3 py-2 text-center">G</th>
                <th class="border px-3 py-2 text-center">B</th>
                <th class="border px-3 py-2 text-center">M</th>
                <th class="border px-3 py-2 text-center">P</th>
              </tr>
            </thead><tbody>`;
      st.forEach((t,i)=>{
        html += '<tr class="'+(i<qualifyCount?'qualified':'')+'">'+
          '<td class="border px-3 py-2 text-center font-bold">'+(i+1)+'</td>'+
          '<td class="border px-3 py-2 font-medium">'+t.name+'</td>'+
          '<td class="border px-3 py-2 text-center">'+t.played+'</td>'+
          '<td class="border px-3 py-2 text-center">'+t.won+'</td>'+
          '<td class="border px-3 py-2 text-center">'+t.drawn+'</td>'+
          '<td class="border px-3 py-2 text-center">'+t.lost+'</td>'+
          '<td class="border px-3 py-2 text-center font-bold">'+t.points+'</td>'+
        '</tr>';
      });
      html += `</tbody></table>
        <div class="mt-4 text-sm text-gray-600 flex items-center space-x-2">
          <div class="w-4 h-4 bg-green-200 border border-green-300"></div>
          <span>Bir sonraki tura çıkan öğrenciler (İlk ${qualifyCount})</span>
        </div></div>`;
      content.innerHTML=html;
    }

    /* ---------- Gelecek Maçlar ---------- */
    function fillUpcomingWeekSelect(){
      let maxWeek=0;
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{
        ensureFixturesForGroup(g);
        const weeks=leagueData.fixtures[g]?.length||0;
        if (weeks>maxWeek) maxWeek=weeks;
      });
      const sel=document.getElementById('upcomingWeekSelect');
      if (!sel) return;
      sel.innerHTML='';
      for(let w=1; w<=maxWeek; w++){
        const o=document.createElement('option'); o.value=String(w); o.textContent=w+'. Hafta'; sel.appendChild(o);
      }
      if (!sel.value) sel.value='1';
    }
    function showUpcoming(){
      const week=parseInt(document.getElementById('upcomingWeekSelect')?.value||'1',10);
      const out=document.getElementById('upcomingContent');
      let html='';
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{
        const weeks=leagueData.fixtures[g]||[];
        const w=weeks.find(x=>x.week===week);
        if (w && w.matches && w.matches.length){
          html += '<div class="mb-6 border border-gray-200 rounded-lg">'+
                    '<div class="px-4 py-2 bg-indigo-50 border-b border-gray-200 font-semibold text-indigo-800">Grup '+g+' — '+week+'. Hafta</div>'+
                    '<div class="p-4 space-y-2">'+
                      w.matches.map(m=>{
                        const r=leagueData.results[m.id];
                        const has=(r && r.homeScore!=='' && r.awayScore!=='' && r.homeScore!=null && r.awayScore!=null);
                        return '<div class="flex items-center bg-white rounded px-3 py-2 shadow-sm">'+
                                '<span class="flex-1 text-right font-medium">'+m.home+'</span>'+
                                '<span class="mx-2 text-gray-500">vs</span>'+
                                '<span class="flex-1 font-medium">'+m.away+'</span>'+
                                (has?('<span class="ml-3 text-sm text-gray-600">('+(r.homeScore)+' - '+(r.awayScore)+')</span>'):'')+
                              '</div>';
                      }).join('')+
                    '</div></div>';
        }
      });
      out.innerHTML = html || '<div class="text-gray-500">Bu hafta için listelenecek maç bulunamadı.</div>';
    }

    /* ---------- Toplu Puan Durumu (DÜZELTİLDİ) ---------- */
    function renderAllStandings(){
      const grid=document.getElementById('allStandingsGrid');
      if (!grid) return;
      let html='';
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{
        const hasMember=(leagueData.groups[g]||[]).some(n=>n && n.trim()!=='');
        if (!hasMember) return;
        ensureFixturesForGroup(g);
        const st=calculateStandings(g);
        let rows='';
        st.forEach((t,i)=>{
          rows += '<tr class="'+(i<4?'qualified':'')+'">'+
                    '<td class="border px-2 py-1 text-center text-sm">'+(i+1)+'</td>'+
                    '<td class="border px-2 py-1 text-sm">'+t.name+'</td>'+
                    '<td class="border px-2 py-1 text-center text-sm">'+t.points+'</td>'+
                  '</tr>';
        });
        html += '<div class="border border-gray-200 rounded-lg overflow-hidden">'+
                  '<div class="px-3 py-2 bg-indigo-600 text-white font-semibold">Grup '+g+'</div>'+
                  '<div class="p-3 overflow-x-auto">'+
                    '<table class="w-full border-collapse">'+
                      '<thead><tr class="bg-gray-100">'+
                        '<th class="border px-2 py-1 text-center text-xs w-10">S</th>'+
                        '<th class="border px-2 py-1 text-left text-xs">Öğrenci</th>'+
                        '<th class="border px-2 py-1 text-center text-xs w-10">P</th>'+
                      '</tr></thead>'+
                      '<tbody>'+rows+'</tbody>'+
                    '</table>'+
                  '</div>'+
                '</div>';
      });
      grid.innerHTML = html || '<p class="text-gray-500">Gruplar yüklenemedi.</p>';
    }

    /* ---------- Yapıştırma & Uygulama ---------- */
    function normName(s){ if(!s) return ''; return s.replace(/\u00A0/g,' ').normalize('NFKC').trim().replace(/\s+/g,' ').toLocaleUpperCase('tr-TR'); }
    function parsePasted(text){
      const map={}; const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for(const raw of lines){
        const line=raw.replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
        let m=line.match(/^(.*?)[\t,;:|-]\s*([0-9]+)$/); if(!m) m=line.match(/^(.*)\s+([0-9]+)$/);
        if(m){ const name=normName(m[1]); const score=parseInt(m[2],10); if(!isNaN(score)&&name) map[name]=score; }
      }
      return map;
    }
    function previewFromPaste(){
      const g=document.getElementById('dataGroupSelect').value;
      const week=parseInt(document.getElementById('dataWeekSelect').value,10);
      const txt=document.getElementById('pasteInput').value;
      const area=document.getElementById('previewArea');
      if(!g){ area.innerHTML='<p class="text-red-600">Lütfen grup seçin.</p>'; return; }
      ensureFixturesForGroup(g);
      const fixtures=leagueData.fixtures[g]||[];
      const thisWeek=fixtures.find(w=>w.week===week);
      if(!thisWeek){ area.innerHTML='<p class="text-red-600">Bu grup için bu hafta yok.</p>'; return; }
      const map=parsePasted(txt);
      const groupMembers=(leagueData.groups[g]||[]).map(normName);
      const unknown=Object.keys(map).filter(n=>!groupMembers.includes(n));
      let html='<div class="mb-3 text-sm text-gray-700">Eşleşen skorlar <b>Hafta '+week+'</b> için hazırlanıyor. Listede olmayan öğrenciler otomatik <b>0</b> alacak.</div>';
      if(unknown.length){ html+='<div class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm">Bu isimler grupta bulunamadı ve yok sayılacak: <b>'+unknown.join(', ')+'</b></div>'; }
      html+='<div class="overflow-x-auto"><table class="w-full border-collapse"><thead><tr class="bg-gray-100">'+
            '<th class="border px-2 py-1 text-left">Ev Sahibi</th><th class="border px-2 py-1 w-20">Skor</th><th class="border px-2 py-1 w-6"></th>'+
            '<th class="border px-2 py-1 text-left">Deplasman</th><th class="border px-2 py-1 w-20">Skor</th></tr></thead><tbody>';
      html += thisWeek.matches.map(m=>{
        const hs=map[normName(m.home)] ?? 0; const as=map[normName(m.away)] ?? 0;
        return '<tr><td class="border px-2 py-1">'+m.home+'</td><td class="border px-2 py-1 text-center">'+hs+'</td>'+
               '<td class="border px-2 py-1 text-center">-</td><td class="border px-2 py-1">'+m.away+'</td>'+
               '<td class="border px-2 py-1 text-center">'+as+'</td></tr>';
      }).join('');
      html += '</tbody></table></div>';
      window.__previewData6={ group:g, week, map };
      const btn=document.getElementById('btnApplyTop'); if(btn){ btn.disabled=false; btn.classList.remove('btn-disabled'); }
      area.innerHTML = html + '<div class="mt-3 text-xs text-gray-500">Önizleme hazır. Yukarıdaki <b>Sonuçları Uygula</b> düğmesi aktif.</div>';
    }
    function applyFromTop(){
      const pd=window.__previewData6; if(!pd){ alert('Önce Eşleştir & Önizle yapın.'); return; }
      applyPreview(pd.group, pd.week);
    }
    function applyPreview(g, week){
      const pd=window.__previewData6; if(!pd || pd.group!==g || pd.week!==week) return;
      ensureFixturesForGroup(g);
      const thisWeek=(leagueData.fixtures[g]||[]).find(w=>w.week===week); if(!thisWeek) return;
      for(const m of thisWeek.matches){
        const hs=pd.map[normName(m.home)] ?? 0;
        const as=pd.map[normName(m.away)] ?? 0;
        if(!leagueData.results[m.id]) leagueData.results[m.id]={};
        leagueData.results[m.id].homeScore=hs;
        leagueData.results[m.id].awayScore=as;
      }
      saveData();
      const fixtureSelect=document.getElementById('fixtureGroupSelect'); if(fixtureSelect) fixtureSelect.value=g;
      showFixtures();
      const target=document.getElementById('week_'+week); if(target){ target.classList.add('flash'); target.scrollIntoView({behavior:'smooth', block:'start'}); setTimeout(()=>target.classList.remove('flash'),1200); }
      if (document.getElementById('standingsGroupSelect').value===g) showStandings();
      if (document.getElementById('allstandings').classList.contains('active')) renderAllStandings();
      const area=document.getElementById('previewArea');
      area.innerHTML='<div class="p-3 rounded bg-emerald-50 border border-emerald-200 text-emerald-800">✅ Sonuçlar kaydedildi. Fikstür ve Puan Durumu güncellendi.</div>';
      const btn=document.getElementById('btnApplyTop'); if(btn){ btn.disabled=true; btn.classList.add('btn-disabled'); }
    }

    /* ---------- Sekmeler ---------- */
    function showTab(tabName, btn){
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>{ b.classList.remove('text-indigo-600','border-b-2','border-indigo-600'); b.classList.add('text-gray-500'); });
      if (btn){ btn.classList.remove('text-gray-500'); btn.classList.add('text-indigo-600','border-b-2','border-indigo-600'); }
      if (tabName==='standings') showStandings();
      if (tabName==='fixtures') showFixtures();
      if (tabName==='upcoming'){ fillUpcomingWeekSelect(); showUpcoming(); }
      if (tabName==='allstandings') renderAllStandings();
    }

    /* ---------- Init ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      loadData();
      // Hiç veri yoksa örnek grupları ekle
      const hasAnyMember = Object.values(leagueData.groups||{}).some(arr=>Array.isArray(arr) && arr.some(n=>n && n.trim()!==''));
      if (!hasAnyMember){ initializeWithSampleData(); }
      initializeGroups();
      'ABCDEFGHIJKLMN'.split('').forEach(g=>ensureFixturesForGroup(g));
      saveData();
      populateGroupSelects();
      createDownloadableBackup();

      const sel=document.getElementById('standingsGroupSelect');
      if (sel && sel.options.length>1){ sel.selectedIndex=1; showStandings(); }

      fillUpcomingWeekSelect(); showUpcoming();
      renderAllStandings();
    });
  </script>
  <a id="downloadBackup" style="display:none"></a>
</body>
</html>
