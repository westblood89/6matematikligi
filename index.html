<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matematik Ligi Yönetim Sistemi — 6. Sınıflar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .qualified { background-color: #dcfce7 !important; }
    .flash { animation: flash 1.2s ease-out 1; }
    @keyframes flash { from { background:#fef9c3; } to { background:transparent; } }
    .btn-disabled { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-center mb-4">
        <div class="text-4xl mr-4">🎒</div>
        <div class="text-center">
          <h1 class="text-3xl font-bold text-indigo-800 mb-2">🏆 Matematik Ligi</h1>
          <div class="text-center">
            <span class="text-gray-600 font-medium text-xl">6. Sınıflar Grup Aşaması</span>
          </div>
        </div>
        <div class="text-4xl ml-4">📚</div>
      </div>
      <div class="flex justify-center items-center space-x-4 text-2xl">
        <span>✏️</span><span>📝</span><span>🧮</span><span>📐</span><span>📏</span>
        <span>🔢</span><span>➕</span><span>➖</span><span>✖️</span><span>➗</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-lg mb-6">
      <div class="flex flex-wrap border-b">
        <button onclick="showTab('standings', this)" class="tab-btn px-4 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600">
          📊 Puan Durumu
        </button>
        <button onclick="showTab('fixtures', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          📅 Fikstür
        </button>
        <button onclick="showTab('upcoming', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          🗓️ Gelecek Maçlar
        </button>
        <button onclick="showTab('mini', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          🧩 Toplu Puan Durumu
        </button>
        <button onclick="showTab('dataentry', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">
          📥 Veri Girişi
        </button>
      </div>
    </div>

    <!-- Standings -->
    <div id="standings" class="tab-content active">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Puan Durumu</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="standingsGroupSelect" onchange="showStandings()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>
        <div id="standingsContent"></div>
      </div>
    </div>

    <!-- Fixtures -->
    <div id="fixtures" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Fikstür ve Sonuçlar</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="fixtureGroupSelect" onchange="showFixtures()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>

        <!-- Backup -->
        <div class="mb-4 flex gap-2">
          <button onclick="downloadBackup()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm">💾 Yedeği İndir</button>
          <label class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm cursor-pointer">
            📤 Yedekten Yükle
            <input type="file" id="restoreInput" accept="application/json" class="hidden" onchange="restoreFromFile(event)" />
          </label>
        </div>

        <div id="fixtureContent"></div>
      </div>
    </div>

    <!-- Upcoming -->
    <div id="upcoming" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Gelecek Maçlar (Hafta Bazlı)</h2>
        <div class="mb-4 flex items-end gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Hafta Seç:</label>
            <select id="upcomingWeekSelect" class="border border-gray-300 rounded-lg px-3 py-2" onchange="showUpcoming()"></select>
          </div>
          <div class="text-sm text-gray-600">Seçilen haftada tüm grupların maçları listelenir.</div>
        </div>
        <div id="upcomingContent"></div>
      </div>
    </div>

    <!-- Mini Standings -->
    <div id="mini" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Toplu Puan Durumu</h2>
        <p class="text-sm text-gray-600 mb-3">Tüm grupların özet tabloları. Geniş ekranda ikişer sütun görünür.</p>
        <div id="miniContent" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>

    <!-- Data Entry -->
    <div id="dataentry" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Veri Girişi (Toplu Yapıştır)</h2>

        <div class="grid md:grid-cols-3 gap-4 mb-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
            <select id="dataGroupSelect" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">Grup seçin...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Hafta:</label>
            <select id="dataWeekSelect" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              <option value="7">7</option>
            </select>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnPreview" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg"
                    onclick="previewFromPaste()">Eşleştir & Önizle</button>
            <button id="btnApplyTop" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg btn-disabled" disabled
                    onclick="applyFromTop()">Sonuçları Uygula</button>
          </div>
        </div>

        <div class="mb-2 text-sm text-gray-600">
          <p>Biçim örnekleri: <code>Ad<TAB>12</code> · <code>Ad,12</code> · <code>Ad; 12</code> · <code>Ad 12</code></p>
          <p>Listede adı <u>yoksa</u> o öğrenci bu hafta <b>0</b> alır.</p>
        </div>

        <textarea id="pasteInput" rows="10" class="w-full border border-gray-300 rounded-lg p-3 font-mono text-sm"
          placeholder="ÖĞRENCİ ADI[TAB veya , ; boşluk]PUAN
MELİS MİRA OSMANBAŞ 11
YAĞIZ AVCI 12
DURU KÜÇÜKSÜMBÜL 10"></textarea>

        <div id="previewArea" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Depolama ----------
    const STORAGE_KEY = 'mathLeagueData6';
    let leagueData = { groups: {}, fixtures: {}, results: {}, matchIndex: {} };

    // ---------- Yedek ----------
    function createDownloadableBackup() {
      const dataStr = JSON.stringify(leagueData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      let a = document.getElementById('downloadBackup');
      if (!a) { a = document.createElement('a'); a.id = 'downloadBackup'; a.style.display = 'none'; document.body.appendChild(a); }
      a.href = URL.createObjectURL(dataBlob);
      a.download = `matematik_ligi_6sinif_yedek_${new Date().toISOString().slice(0,10)}.json`;
    }
    function downloadBackup(){ const a=document.getElementById('downloadBackup'); if(a) a.click(); }
    function restoreFromFile(ev){
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          if (obj && obj.groups && obj.fixtures && obj.results) {
            leagueData = { matchIndex:{}, ...obj };
            if (!leagueData.matchIndex) leagueData.matchIndex = {};
            // Eski kayıtlarda isim düzeltmeleri
            migrateOykucap();
            migrateSeifzadeh();
            // Fikstür indekslerini tazele
            Object.keys(leagueData.fixtures||{}).forEach(g => buildMatchIndex(g));
            saveData();
            initializeGroups(); populateGroupSelects();
            showFixtures(); showStandings();
            fillUpcomingWeekSelect(); showUpcoming();
            renderMiniStandings();
            alert('✅ Yedekten geri yüklendi');
          } else { alert('❌ Geçersiz yedek dosyası'); }
        } catch { alert('❌ Dosya okunamadı'); }
        ev.target.value = '';
      };
      reader.readAsText(f);
    }

    function saveData(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(leagueData)); createDownloadableBackup(); } catch(e){ console.error(e);} }
    function loadData(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) { try { leagueData = { matchIndex:{}, ...JSON.parse(saved) }; if (!leagueData.matchIndex) leagueData.matchIndex = {}; } catch(e){} }
    }

    // ---------- Başlangıç Grupları (düzeltilmiş isimlerle) ----------
    function initializeWithProvidedGroups(){
      leagueData.groups['A'] = ['KERİM MERT POLAT','PARS ERTAŞ','MERT RIZGAR YEŞİLMEN','BADE ŞAHİN','MEHMET YAMAN MUMCU','KEREM SAYAR','ELİF SARE GENÇALP','MERT ALİ ÜNLÜ'];
      leagueData.groups['B'] = ['YUSUF GÖKALP SAKARYA','LİLA ERGÜN','DURU MİRA ÖDÜL','MİRA TEMÜR','KUZEY PEKŞEN','EFE ÇAĞLAR','DEMİR ALİ KABAKTAŞ','EVİN İPEK ÖZGEN'];
      leagueData.groups['C'] = ['ABDULLAH EFE ÖZTÜRK','EMİR MİRAS','KIVANÇ KARABULUT','CEM AKDENİZ','AYBÜKE ÜZE','EFE ATTEPE','ALİ DEMİR ÇABUK','ZUHAL UMAY ÇETİN'];
      leagueData.groups['D'] = ['ARVEN TÜRK','DERİN DEMİRKAYA','TAN SOYÖZ','SELİM SANCAK','BATU ŞAHİN','EYMEN ÖZDEMİR','MERT RIFAT ÇEBİ','ELİF ADRİANA OKUR'];
      leagueData.groups['E'] = ['HALİL İBRAHİM BAYSOY','POYRAZ ÜNGÜDER','TANEM DENİZ MERTLER','MELİS MİRA OSMANBAŞ','DURU KÜÇÜKSÜMBÜL','RABİA BAHAR ÇAN','İNCİ JANSELİ KAVAL','BARIŞ TOKGÖZ'];
      leagueData.groups['F'] = ['DENİZ ÇAKIR','DOĞUKAN ARSLAN','SELEN IŞIK','DOĞUKAN KILIÇ','AYSAN SEIFZADEH','ALİ KAAN MERCAN','MEHMET ÇAĞAN KIZILOĞLU','ALYA SENA ÇİÇEK']; // SEİFZADEH->SEIFZADEH
      leagueData.groups['G'] = ['BATU DURUKAN','KENAN SARP ÇÖTE','EMİRCAN RAHİMOĞLU','ELİS TEKE','SARP BALCIOĞLU','SEVİNÇ ECE BİLGİÇ','NASRİ ÇİÇEK','CEVDET AKİF TOKLU'];
      leagueData.groups['H'] = ['MİRA GÖZENER','ASYA MİNA ÖZ','ARHAN AKARSU','AYŞE ÖYKÜ YILDIRIM','ANIL CANSU YILMAZ','NİL ERSAN','KEREM TEKİN','DERİN SİNEF DİN'];
      leagueData.groups['I'] = ['BERAT AĞIRMAN','ATLAS BAHADIR','YAĞMUR ELİF BİNGÖL','MİRA İNECİ','CANSU YILMAZ','KEREM ÖZTÜRK','CEMAL SALMANLI','ARES DOĞAN'];
      leagueData.groups['J'] = ['PELİN USTA','DENİZ GÖKSU','DERİN BOZKURT','BELİZ SU BAŞARSLAN','ASYA KARAMAN','İPEK NİSA KOÇBAY','İPEK PAPİN','YUSUF EFE KARAGÖZOĞLU'];
      leagueData.groups['K'] = ['AYAZ ALİ YILDIRIM','MİRZA ÖZBEKLİ','ZEYNEP ARSLAN','SARP SALİHOĞLU','SARE YILMAZ','ERDAL ATİLLA ŞAKAR','KUZEY MERT YILMAZ','BARDIA EBRAHIMI ESHRATABADY'];
      leagueData.groups['L'] = ['YAĞIZ AVCI','ATLAS DENİZ ÇELİK','DERİN YALÇINKAYA','BERKEN AREL AYAZ','ÖMER KALEBAŞ','ECE NUR EGE','EGEMEN ÇALIŞKAN','KERİM KARKIN'];
      leagueData.groups['M'] = ['AYŞE SERRA KARTAL','YAŞAR YAMAN YOLCU','İLAY MELEK MEYDAN','DENİZ EROL BAŞARSLAN','ÖYKÜ CAP','ECE KÜÇÜKDALGIÇ','NAZLI USKUÇ','KAYRA RESUL GÖZÜBÜYÜK']; // ÇAP->CAP
      leagueData.groups['N'] = ['GÜNEY ŞİMŞEK','DORUK DOĞAN','ADA ERAKPINAR','DURU SAĞDIÇ','BÖLÜM SONU CANAVARI','ABDULKADİR ALP ALTINTAŞ','ELA YILMAZ','BADE SEZGİN'];
    }

    // ---------- Grupları tamamlama ----------
    function initializeGroups(){
      'ABCDEFGHIJKLMN'.split('').forEach(letter=>{
        if (!leagueData.groups[letter]) leagueData.groups[letter] = Array(8).fill('');
      });
    }

    // ---------- Fikstür ----------
    function generateFixtures(group){
      const members = (leagueData.groups[group]||[]).filter(m=>m && m.trim()!=='');
      const n = members.length; if (n < 2) return [];
      const weeks = n - 1;
      const fixtures = Array.from({length: weeks}, (_,i)=>({week:i+1, matches:[]}));
      // tüm eşleşmeler
      const all = [];
      let id=0;
      for (let i=0;i<n;i++) for (let j=i+1;j<n;j++) all.push({ id: `${group}_${id++}`, home: members[i], away: members[j] });
      // haftalara yerleştir (aynı haftada aynı kişi 2 maç yapmasın)
      let wi=0;
      for (const m of all){
        let placed=false, tries=0;
        while(!placed && tries<weeks){
          const w = fixtures[wi];
          const used = new Set(); w.matches.forEach(x=>{ used.add(x.home); used.add(x.away); });
          if (!used.has(m.home) && !used.has(m.away)){ w.matches.push({...m}); placed=true; }
          wi = (wi+1) % weeks; tries++;
        }
      }
      return fixtures;
    }
    function ensureFixturesForGroup(g){
      if (!leagueData.fixtures[g] || !leagueData.fixtures[g].length){
        leagueData.fixtures[g] = generateFixtures(g);
      }
    }
    function buildMatchIndex(g){
      const fx = leagueData.fixtures[g]||[];
      for (const w of fx){
        for (const m of w.matches){
          leagueData.matchIndex[m.id] = { group:g, week:w.week, home:m.home, away:m.away };
        }
      }
    }

    // ---------- Seçicileri doldur ----------
    function populateGroupSelects(){
      const fixtureSelect = document.getElementById('fixtureGroupSelect');
      const standingsSelect = document.getElementById('standingsGroupSelect');
      const dataGroupSelect = document.getElementById('dataGroupSelect');
      if (fixtureSelect) fixtureSelect.innerHTML = '<option value="">Grup seçin...</option>';
      if (standingsSelect) standingsSelect.innerHTML = '<option value="">Grup seçin...</option>';
      if (dataGroupSelect) dataGroupSelect.innerHTML = '<option value="">Grup seçin...</option>';
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{
        const has = (leagueData.groups[g]||[]).some(n=>n && n.trim()!=='');
        if (has){
          const txt = 'Grup ' + g;
          const o1=document.createElement('option'); o1.value=g; o1.textContent=txt; fixtureSelect?.appendChild(o1);
          const o2=document.createElement('option'); o2.value=g; o2.textContent=txt; standingsSelect?.appendChild(o2);
          const o3=document.createElement('option'); o3.value=g; o3.textContent=txt; dataGroupSelect?.appendChild(o3);
        }
      });
    }

    // ---------- Puan Durumu ----------
    function calculateStandings(group){
      const members = (leagueData.groups[group]||[]).filter(m=>m.trim()!=='');
      const S = members.map(n=>({name:n, played:0, won:0, drawn:0, lost:0, correct:0, wrong:0, goalDifference:0, points:0}));
      const idx = Object.fromEntries(S.map((s,i)=>[s.name,i]));
      Object.keys(leagueData.results||{}).forEach(matchId=>{
        const meta = leagueData.matchIndex[matchId];
        if (!meta || meta.group !== group) return;
        const r = leagueData.results[matchId];
        if (r.homeScore==='' || r.awayScore==='' || r.homeScore==null || r.awayScore==null) return;
        const hi = idx[meta.home], ai = idx[meta.away]; if (hi===undefined || ai===undefined) return;
        const hs = parseInt(r.homeScore)||0, as = parseInt(r.awayScore)||0;
        const H=S[hi], A=S[ai];
        H.played++; A.played++;
        H.correct+=hs; H.wrong+=as; A.correct+=as; A.wrong+=hs;
        if (hs>as){ H.won++; H.points+=3; A.lost++; }
        else if (hs<as){ A.won++; A.points+=3; H.lost++; }
        else { H.drawn++; A.drawn++; H.points++; A.points++; }
        H.goalDifference = H.correct - H.wrong;
        A.goalDifference = A.correct - A.wrong;
      });
      S.sort((a,b)=>(b.points-a.points)||(b.goalDifference-a.goalDifference)||(b.correct-a.correct));
      return S;
    }

    function showStandings(){
      const g = document.getElementById('standingsGroupSelect').value;
      const out = document.getElementById('standingsContent');
      if (!g){ out.innerHTML='<p class="text-gray-500">Lütfen bir grup seçin.</p>'; return; }
      ensureFixturesForGroup(g);
      const standings = calculateStandings(g);
      const qualifyCount = 4;
      out.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-indigo-600 text-white">
                <th class="border px-3 py-2 text-center">Sıra</th>
                <th class="border px-3 py-2 text-left">Öğrenci</th>
                <th class="border px-3 py-2 text-center">O</th>
                <th class="border px-3 py-2 text-center">G</th>
                <th class="border px-3 py-2 text-center">B</th>
                <th class="border px-3 py-2 text-center">M</th>
                <th class="border px-3 py-2 text-center">P</th>
              </tr>
            </thead>
            <tbody>
              ${standings.map((t,i)=>`
                <tr class="${i<qualifyCount?'qualified':''}">
                  <td class="border px-3 py-2 text-center font-bold">${i+1}</td>
                  <td class="border px-3 py-2 font-medium">${t.name}</td>
                  <td class="border px-3 py-2 text-center">${t.played}</td>
                  <td class="border px-3 py-2 text-center">${t.won}</td>
                  <td class="border px-3 py-2 text-center">${t.drawn}</td>
                  <td class="border px-3 py-2 text-center">${t.lost}</td>
                  <td class="border px-3 py-2 text-center font-bold">${t.points}</td>
                </tr>`).join('')}
            </tbody>
          </table>
          <div class="mt-3 text-sm text-gray-600 flex items-center gap-2">
            <div class="w-4 h-4 bg-green-200 border border-green-300"></div>
            <span>Bir sonraki tura çıkan öğrenciler (İlk ${qualifyCount})</span>
          </div>
        </div>`;
      renderMiniStandings(); // mini de güncellensin
    }

    // ---------- Fikstür + Skor ----------
    function showFixtures(){
      const g = document.getElementById('fixtureGroupSelect').value;
      const out = document.getElementById('fixtureContent');
      if (!g){ out.innerHTML='<p class="text-gray-500">Lütfen bir grup seçin.</p>'; return; }
      ensureFixturesForGroup(g);
      const fixtures = leagueData.fixtures[g]||[];
      out.innerHTML = `
        <div class="space-y-6">
          ${fixtures.map(week=>`
            <div id="week_${week.week}" class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-bold text-lg mb-3 text-indigo-700">${week.week}. Hafta</h3>
              <div class="space-y-2">
                ${week.matches.map(m=>`
                  <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded">
                    <span class="flex-1 text-right font-medium">${m.home}</span>
                    <input type="number" value="${leagueData.results[m.id]?.homeScore ?? ''}"
                           oninput="updateScore('${m.id}','homeScore',this.value)"
                           class="w-12 text-center border border-gray-300 rounded px-2 py-1">
                    <span class="text-gray-500">-</span>
                    <input type="number" value="${leagueData.results[m.id]?.awayScore ?? ''}"
                           oninput="updateScore('${m.id}','awayScore',this.value)"
                           class="w-12 text-center border border-gray-300 rounded px-2 py-1">
                    <span class="flex-1 font-medium">${m.away}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>`;
    }

    function updateScore(matchId, key, val){
      if (!leagueData.results[matchId]) leagueData.results[matchId] = {};
      if (val === '') leagueData.results[matchId][key] = '';
      else {
        const n = parseInt(val,10);
        leagueData.results[matchId][key] = isNaN(n) ? '' : n;
      }
      saveData();
      const g = leagueData.matchIndex[matchId]?.group || matchId.split('_')[0];
      if (document.getElementById('standingsGroupSelect').value === g) showStandings();
      renderMiniStandings();
    }

    // ---------- Gelecek Maçlar ----------
    function fillUpcomingWeekSelect(){
      let maxWeek = 0;
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{
        ensureFixturesForGroup(g);
        const w = leagueData.fixtures[g]?.length || 0;
        if (w > maxWeek) maxWeek = w;
      });
      const sel = document.getElementById('upcomingWeekSelect');
      if (!sel) return;
      sel.innerHTML = '';
      for (let w=1; w<=maxWeek; w++){
        const o=document.createElement('option'); o.value=String(w); o.textContent=w+'. Hafta'; sel.appendChild(o);
      }
      if (!sel.value) sel.value='1';
    }

    function showUpcoming(){
      const sel = document.getElementById('upcomingWeekSelect');
      const week = parseInt(sel?.value||'1',10);
      const out = document.getElementById('upcomingContent');
      if (!out) return;
      let html = '';
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{
        const w = (leagueData.fixtures[g]||[]).find(x=>x.week===week);
        if (w && w.matches && w.matches.length){
          html += `<div class="mb-6 border border-gray-200 rounded-lg">
            <div class="px-4 py-2 bg-indigo-50 border-b border-gray-200 font-semibold text-indigo-800">Grup ${g} — ${week}. Hafta</div>
            <div class="p-4 space-y-2">
              ${w.matches.map(m=>{
                const r = leagueData.results[m.id];
                const has = r && r.homeScore!=='' && r.awayScore!=='' && r.homeScore!=null && r.awayScore!=null;
                return `<div class="flex items-center bg-white rounded px-3 py-2 shadow-sm">
                  <span class="flex-1 text-right font-medium">${m.home}</span>
                  <span class="mx-2 text-gray-500">vs</span>
                  <span class="flex-1 font-medium">${m.away}</span>
                  ${has ? `<span class="ml-3 text-sm text-gray-600">(${r.homeScore} - ${r.awayScore})</span>` : ''}
                </div>`;
              }).join('')}
            </div>
          </div>`;
        }
      });
      out.innerHTML = html || '<div class="text-gray-500">Bu hafta için maç bulunamadı.</div>';
    }

    // ---------- Toplu (Mini) Puan Durumu ----------
    function renderMiniStandings(){
      const wrap = document.getElementById('miniContent');
      if (!wrap) return;
      let html = '';
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{
        const members = (leagueData.groups[g]||[]).filter(x=>x && x.trim()!=='');
        if (!members.length) return;
        ensureFixturesForGroup(g);
        const S = calculateStandings(g);
        html += `
          <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
            <div class="px-3 py-2 bg-indigo-50 border-b border-gray-200 font-semibold text-indigo-800">Grup ${g}</div>
            <div class="p-3 overflow-x-auto">
              <table class="w-full text-xs border-collapse">
                <thead>
                  <tr class="text-gray-700">
                    <th class="border px-2 py-1 text-center">S</th>
                    <th class="border px-2 py-1 text-left">Öğrenci</th>
                    <th class="border px-2 py-1 text-center">O</th>
                    <th class="border px-2 py-1 text-center">G</th>
                    <th class="border px-2 py-1 text-center">B</th>
                    <th class="border px-2 py-1 text-center">M</th>
                    <th class="border px-2 py-1 text-center">P</th>
                  </tr>
                </thead>
                <tbody>
                  ${S.map((t,i)=>`
                    <tr class="${i<4?'qualified':''}">
                      <td class="border px-2 py-1 text-center font-medium">${i+1}</td>
                      <td class="border px-2 py-1">${t.name}</td>
                      <td class="border px-2 py-1 text-center">${t.played}</td>
                      <td class="border px-2 py-1 text-center">${t.won}</td>
                      <td class="border px-2 py-1 text-center">${t.drawn}</td>
                      <td class="border px-2 py-1 text-center">${t.lost}</td>
                      <td class="border px-2 py-1 text-center font-bold">${t.points}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>`;
      });
      wrap.innerHTML = html || '<div class="text-gray-500 text-sm">Henüz listelenecek grup yok.</div>';
    }

    // ---------- İsim normalizasyonu & Yapıştırma ----------
    function normName(s){
      if (!s) return '';
      return s.replace(/\u00A0/g,' ').normalize('NFKC').trim().replace(/\s+/g,' ').toLocaleUpperCase('tr-TR');
    }
    function parsePasted(text){
      const map = {};
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for (const raw of lines){
        const line = raw.replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
        let m = line.match(/^(.*?)[\t,;:|-]\s*([0-9]+)$/);
        if (!m) m = line.match(/^(.*)\s+([0-9]+)$/);
        if (m){
          const name = normName(m[1]);
          const score = parseInt(m[2],10);
          if (!isNaN(score) && name) map[name] = score;
        }
      }
      return map;
    }

    function previewFromPaste(){
      const g = document.getElementById('dataGroupSelect').value;
      const week = parseInt(document.getElementById('dataWeekSelect').value,10);
      const txt = document.getElementById('pasteInput').value;
      const area = document.getElementById('previewArea');

      if (!g){ area.innerHTML = '<p class="text-red-600">Lütfen grup seçin.</p>'; return; }
      ensureFixturesForGroup(g);

      const fixtures = leagueData.fixtures[g]||[];
      const thisWeek = fixtures.find(w=>w.week===week);
      if (!thisWeek){ area.innerHTML = '<p class="text-red-600">Bu grup için bu hafta yok.</p>'; return; }

      const map = parsePasted(txt);
      const groupMembers = (leagueData.groups[g]||[]).map(normName);
      const unknown = Object.keys(map).filter(n=>!groupMembers.includes(n));

      let html = '';
      html += `<div class="mb-3 text-sm text-gray-700">Eşleşen skorlar <b>Hafta ${week}</b> için hazırlanıyor. Listede olmayanlar otomatik <b>0</b> alır.</div>`;
      if (unknown.length){
        html += `<div class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm">
          Grupta bulunamadı (yok sayılacak): <b>${unknown.join(', ')}</b>
        </div>`;
      }
      html += `<div class="overflow-x-auto"><table class="w-full border-collapse">
        <thead><tr class="bg-gray-100">
          <th class="border px-2 py-1 text-left">Ev Sahibi</th>
          <th class="border px-2 py-1 w-20">Skor</th>
          <th class="border px-2 py-1 w-6"></th>
          <th class="border px-2 py-1 text-left">Deplasman</th>
          <th class="border px-2 py-1 w-20">Skor</th>
        </tr></thead><tbody>`;

      const rows = thisWeek.matches.map(m=>{
        const hs = map[normName(m.home)] ?? 0;
        const as = map[normName(m.away)] ?? 0;
        return `<tr>
          <td class="border px-2 py-1">${m.home}</td>
          <td class="border px-2 py-1 text-center">${hs}</td>
          <td class="border px-2 py-1 text-center">-</td>
          <td class="border px-2 py-1">${m.away}</td>
          <td class="border px-2 py-1 text-center">${as}</td>
        </tr>`;
      }).join('');

      html += rows + `</tbody></table></div>`;

      window.__previewData6 = { group:g, week, map };
      const btn = document.getElementById('btnApplyTop');
      if (btn) { btn.disabled = false; btn.classList.remove('btn-disabled'); }
      area.innerHTML = html + `<div class="mt-3 text-xs text-gray-500">Önizleme hazır. Yukarıdaki <b>Sonuçları Uygula</b> düğmesi aktif.</div>`;
    }

    function applyFromTop(){
      const pd = window.__previewData6;
      if (!pd) { alert('Önce Eşleştir & Önizle yapın.'); return; }
      applyPreview(pd.group, pd.week);
    }

    function applyPreview(g, week){
      const pd = window.__previewData6;
      if (!pd || pd.group!==g || pd.week!==week) return;
      ensureFixturesForGroup(g);
      const thisWeek = (leagueData.fixtures[g]||[]).find(w=>w.week===week);
      if (!thisWeek) return;

      for (const m of thisWeek.matches){
        const hs = pd.map[normName(m.home)] ?? 0;
        const as = pd.map[normName(m.away)] ?? 0;
        if (!leagueData.results[m.id]) leagueData.results[m.id] = {};
        leagueData.results[m.id].homeScore = hs;
        leagueData.results[m.id].awayScore = as;
        leagueData.matchIndex[m.id] = { group:g, week:week, home:m.home, away:m.away };
      }
      saveData();

      const fixtureSelect = document.getElementById('fixtureGroupSelect');
      if (fixtureSelect) fixtureSelect.value = g;
      showFixtures();
      const target = document.getElementById('week_'+week);
      if (target){ target.classList.add('flash'); target.scrollIntoView({behavior:'smooth', block:'start'}); setTimeout(()=>target.classList.remove('flash'),1200); }

      if (document.getElementById('standingsGroupSelect').value === g) showStandings();
      renderMiniStandings();

      const area = document.getElementById('previewArea');
      area.innerHTML = '<div class="p-3 rounded bg-emerald-50 border border-emerald-200 text-emerald-800">✅ Sonuçlar kaydedildi. Fikstür ve Puan Durumu güncellendi.</div>';
      const btn = document.getElementById('btnApplyTop');
      if (btn){ btn.disabled = true; btn.classList.add('btn-disabled'); }
    }

    // ---------- İsim göçleri (eski yedekler için) ----------
    function migrateOykucap(){
      const g='M', OLD='ÖYKÜ ÇAP', NEW='ÖYKÜ CAP';
      const arr = leagueData.groups[g]||[]; let changed=false;
      for (let i=0;i<arr.length;i++){ if ((arr[i]||'').trim().toLocaleUpperCase('tr-TR')===OLD){ arr[i]=NEW; changed=true; } }
      leagueData.groups[g]=arr;
      if (leagueData.fixtures[g]) leagueData.fixtures[g].forEach(w=>w.matches.forEach(m=>{ if (m.home?.toLocaleUpperCase('tr-TR')===OLD) m.home=NEW; if (m.away?.toLocaleUpperCase('tr-TR')===OLD) m.away=NEW; }));
      if (changed) saveData();
    }
    function migrateSeifzadeh(){
      const g='F', OLD='AYSAN SEİFZADEH', NEW='AYSAN SEIFZADEH';
      const arr = leagueData.groups[g]||[]; let changed=false;
      for (let i=0;i<arr.length;i++){ if ((arr[i]||'').trim().toLocaleUpperCase('tr-TR')===OLD){ arr[i]=NEW; changed=true; } }
      leagueData.groups[g]=arr;
      if (leagueData.fixtures[g]) leagueData.fixtures[g].forEach(w=>w.matches.forEach(m=>{ if (m.home?.toLocaleUpperCase('tr-TR')===OLD) m.home=NEW; if (m.away?.toLocaleUpperCase('tr-TR')===OLD) m.away=NEW; }));
      if (changed) saveData();
    }

    // ---------- Sekmeler ----------
    function showTab(tabName, btn){
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>{ b.classList.remove('text-indigo-600','border-b-2','border-indigo-600'); b.classList.add('text-gray-500'); });
      if (btn){ btn.classList.remove('text-gray-500'); btn.classList.add('text-indigo-600','border-b-2','border-indigo-600'); }
      if (tabName==='standings') showStandings();
      if (tabName==='fixtures') showFixtures();
      if (tabName==='upcoming'){ fillUpcomingWeekSelect(); showUpcoming(); }
      if (tabName==='mini') renderMiniStandings();
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      loadData();

      // Hiç veri yoksa sağlanan grupları kur
      const hasAny = Object.values(leagueData.groups||{}).some(arr=>Array.isArray(arr)&&arr.some(n=>n&&n.trim()!==''));
      if (!hasAny) initializeWithProvidedGroups();

      // İsim göçleri
      migrateOykucap();
      migrateSeifzadeh();

      initializeGroups();
      // Fikstür üret ve indeksleri kur
      'ABCDEFGHIJKLMN'.split('').forEach(g=>{ ensureFixturesForGroup(g); buildMatchIndex(g); });

      saveData();
      populateGroupSelects();
      createDownloadableBackup();

      // Varsayılan görüntüler
      const selS=document.getElementById('standingsGroupSelect');
      if (selS && selS.options.length>1){ selS.selectedIndex=1; showStandings(); }
      fillUpcomingWeekSelect(); showUpcoming();
      renderMiniStandings();
    });
  </script>
  <a id="downloadBackup" style="display:none"></a>
</body>
</html>
